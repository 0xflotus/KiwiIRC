function manageDebug(a){var b,c;window.console?(c=window.console.log,window.console.log=function(){a&&c.apply(console,arguments)}):(b=window.opera?window.opera.postError:alert,window.console={},window.console.log=function(c){a&&b(c)})}function randomString(a){var b="0123456789ABCDEFGHIJKLMNOPQRSTUVWXTZabcdefghiklmnopqrstuvwxyz",c="",d,e;for(d=0;d<a;d++)e=Math.floor(Math.random()*b.length),c+=b.substring(e,e+1);return c}function secondsToTime(a){var b,c,d,e,f,g;return b=Math.floor(a/3600),e=a%3600,c=Math.floor(e/60),f=e%60,d=Math.ceil(f),g={h:b,m:c,s:d},g}function formatIRCMsg(a){var b,c;if(!a||typeof a!="string")return"";if(a.indexOf(String.fromCharCode(2))!==-1){c="<b>";while(a.indexOf(String.fromCharCode(2))!==-1)a=a.replace(String.fromCharCode(2),c),c=c==="<b>"?"</b>":"<b>";c==="</b>"&&(a+="</b>")}if(a.indexOf(String.fromCharCode(31))!==-1){c="<u>";while(a.indexOf(String.fromCharCode(31))!==-1)a=a.replace(String.fromCharCode(31),c),c=c==="<u>"?"</u>":"<u>";c==="</u>"&&(a+="</u>")}return a=function(a){var b,c,d,e,f,g,h,i,j,k;b="",c=function(a){var b=/^\x03([0-9][0-5]?)(,([0-9][0-5]?))?/;return b.exec(a)},d=function(a){switch(parseInt(a,10)){case 0:return"#FFFFFF";case 1:return"#000000";case 2:return"#000080";case 3:return"#008000";case 4:return"#FF0000";case 5:return"#800040";case 6:return"#800080";case 7:return"#FF8040";case 8:return"#FFFF00";case 9:return"#80FF00";case 10:return"#008080";case 11:return"#00FFFF";case 12:return"#0000FF";case 13:return"#FF55FF";case 14:return"#808080";case 15:return"#C0C0C0";default:return null}};if(a.indexOf("")!==-1){e=a.indexOf(""),b=a.substr(0,e);while(e<a.length)f=c(a.substr(e,6)),f?(g=a.indexOf("",e+1),h=a.indexOf(String.fromCharCode(15),e+1),h!==-1&&(g===-1?g=h:g=g<h?g:h),g===-1&&(g=a.length),i=d(f[1]),j=d(f[3]),k=a.substring(e+1+f[1].length+(j!==null?f[2].length+1:0),g),b+='<span style="'+(i!==null?"color: "+i+"; ":"")+(j!==null?"background-color: "+j+";":"")+'">'+k+"</span>",e=g):(a[e]!==""&&a[e]!==String.fromCharCode(15)&&(b+=a[e]),e++);return b}return a}(a),a}var kiwi={};typeof String.prototype.trim=="undefined"&&(String.prototype.trim=function(){return this.replace(/^\s+|\s+$/g,"")}),typeof String.prototype.lpad=="undefined"&&(String.prototype.lpad=function(a,b){var c="",d;for(d=0;d<a;d++)c+=b;return(c+this).slice(-a)});var plugins=[{name:"images",onaddmsg:function(a,b){return a.msg?(a.msg=a.msg.replace(/^((https?\:\/\/|ftp\:\/\/)|(www\.))(\S+)(\w{2,4})(:[0-9]+)?(\/|\/([\w#!:.?+=&%@!\-\/]))?(\.jpg|\.jpeg|\.gif|\.bmp|\.png)$/gi,function(b){a.event_bubbles=!1;var c='<img class="link_img_a" src="'+b+'" height="100%" width="100%" />';return'<a class="link_ext link_img" target="_blank" rel="nofollow" href="'+b+'" style="height:50px;width:50px;display:block">'+c+'<div class="tt box"></div></a>'}),a):a}},{name:"html_safe",onaddmsg:function(a,b){return a.msg=$("<div/>").text(a.msg).html(),a.nick=$("<div/>").text(a.nick).html(),a}},{name:"activity",onaddmsg:function(a,b){return a}},{name:"highlight",onaddmsg:function(a,b){return a}},{name:"linkify_plain",onaddmsg:function(a,b){return a.msg?(a.msg=a.msg.replace(/((https?\:\/\/|ftp\:\/\/)|(www\.))(\S+)(\w{2,4})(:[0-9]+)?(\/|\/([\w#!:.?+=&%@!\-\/]))?/gi,function(a){var b;return a.match(/(\.jpg|\.jpeg|\.gif|\.bmp|\.png)$/)?a:(b=a,a.match("^https?://")?b=a:a="http://"+a,'<a class="link_ext" target="_blank" rel="nofollow" href="'+a+'">'+b+"</a>")}),a):a}},{name:"lftobr",onaddmsg:function(a,b){return a.msg?(a.msg=a.msg.replace(/\n/gi,function(a){return"<br/>"}),a):a}},{name:"nick_colour",onaddmsg:function(a,b){if(!a.msg)return a;var c=this.randColour();return a.nick='<span style="color:'+c+';">'+a.nick+"</span>",a},randColour:function(){var a=this.rand(-250,0),b=this.rand(30,100),c=this.rand(20,70);return"hsl("+a+","+b+"%,"+c+"%)"},rand:function(a,b){return parseInt(Math.random()*(b-a+1),10)+a}},{name:"kiwitest",oninit:function(a,b){console.log("registering namespace"),$(gateway).bind("kiwi.lol.browser",function(a,b){console.log("YAY kiwitest"),console.log(b)})}}];kiwi.plugs={},kiwi.plugs.loaded={},kiwi.plugs.loadPlugin=function(a){var b;return typeof a.name!="string"?!1:(b=kiwi.plugs.run("plugin_load",{plugin:a}),typeof b=="object"&&(kiwi.plugs.loaded[b.plugin.name]=b.plugin,kiwi.plugs.loaded[b.plugin.name].local_data=new kiwi.dataStore("kiwi_plugin_"+b.plugin.name)),kiwi.plugs.run("init",{},{run_only:b.plugin.name}),!0)},kiwi.plugs.unloadPlugin=function(a){if(typeof kiwi.plugs.loaded[a]!="object")return;kiwi.plugs.run("unload",{},{run_only:a}),delete kiwi.plugs.loaded[a]},kiwi.plugs.run=function(a,b,c){var d=b,e,f;b=typeof b=="undefined"?{}:b,c=typeof c=="undefined"?{}:c;for(f in kiwi.plugs.loaded){if(typeof c.run_only=="string"&&c.run_only!==f)continue;if(typeof kiwi.plugs.loaded[f]["on"+a]=="function")try{e=kiwi.plugs.loaded[f]["on"+a](d,c);if(e===null)return null;d=e;if(typeof d.event_bubbles=="boolean"&&d.event_bubbles===!1)return delete d.event_bubbles,d}catch(g){}}return d},kiwi.dataStore=function(a){var b=a;this.get=function(b){return $.jStorage.get(a+"_"+b)},this.set=function(b,c){return $.jStorage.set(a+"_"+b,c)}},kiwi.data=new kiwi.dataStore("kiwi"),function(a){function i(){if("localStorage"in window)try{window.localStorage&&(c=window.localStorage,h="localStorage")}catch(a){}else if("globalStorage"in window)try{window.globalStorage&&(c=window.globalStorage[window.location.hostname],h="globalStorage")}catch(b){}else{d=document.createElement("link");if(!d.addBehavior){d=null;return}d.style.behavior="url(#default#userData)",document.getElementsByTagName("head")[0].appendChild(d),d.load("jStorage");var e="{}";try{e=d.getAttribute("jStorage")}catch(f){}c.jStorage=e,h="userDataBehavior"}j()}function j(){if(c.jStorage)try{b=g(String(c.jStorage))}catch(a){c.jStorage="{}"}else c.jStorage="{}";e=c.jStorage?String(c.jStorage).length:0}function k(){try{c.jStorage=f(b),d&&(d.setAttribute("jStorage",c.jStorage),d.save("jStorage")),e=c.jStorage?String(c.jStorage).length:0}catch(a){}}function l(a){if(!a||typeof a!="string"&&typeof a!="number")throw new TypeError("Key name must be string or numeric");return!0}if(!a||!(a.toJSON||Object.toJSON||window.JSON))throw new Error("jQuery, MooTools or Prototype needs to be loaded before jStorage!");var b={},c={jStorage:"{}"},d=null,e=0,f=a.toJSON||Object.toJSON||window.JSON&&(JSON.encode||JSON.stringify),g=a.evalJSON||window.JSON&&(JSON.decode||JSON.parse)||function(a){return String(a).evalJSON()},h=!1;_XMLService={isXML:function(a){var b=(a?a.ownerDocument||a:0).documentElement;return b?b.nodeName!=="HTML":!1},encode:function(a){if(!this.isXML(a))return!1;try{return(new XMLSerializer).serializeToString(a)}catch(b){try{return a.xml}catch(c){}}return!1},decode:function(a){var b="DOMParser"in window&&(new DOMParser).parseFromString||window.ActiveXObject&&function(a){var b=new ActiveXObject("Microsoft.XMLDOM");return b.async="false",b.loadXML(a),b},c;return b?(c=b.call("DOMParser"in window&&new DOMParser||window,a,"text/xml"),this.isXML(c)?c:!1):!1}},a.jStorage={version:"0.1.5.1",set:function(a,c){return l(a),_XMLService.isXML(c)&&(c={_is_xml:!0,xml:_XMLService.encode(c)}),b[a]=c,k(),c},get:function(a,c){return l(a),a in b?b[a]&&typeof b[a]=="object"&&b[a]._is_xml&&b[a]._is_xml?_XMLService.decode(b[a].xml):b[a]:typeof c=="undefined"?null:c},deleteKey:function(a){return l(a),a in b?(delete b[a],k(),!0):!1},flush:function(){return b={},k(),!0},storageObj:function(){function a(){}return a.prototype=b,new a},index:function(){var a=[],c;for(c in b)b.hasOwnProperty(c)&&a.push(c);return a},storageSize:function(){return e},currentBackend:function(){return h},storageAvailable:function(){return!!h},reInit:function(){var a,b;if(d&&d.addBehavior){a=document.createElement("link"),d.parentNode.replaceChild(a,d),d=a,d.style.behavior="url(#default#userData)",document.getElementsByTagName("head")[0].appendChild(d),d.load("jStorage"),b="{}";try{b=d.getAttribute("jStorage")}catch(e){}c.jStorage=b,h="userDataBehavior"}j()}},i()}(window.jQuery||window.$),kiwi.model={},kiwi.model.MemberList=Backbone.Collection.extend({model:kiwi.model.Member,comparator:function(a,b){var c,d,e,f,g,h,i,j=kiwi.gateway.get("user_prefixes");d=a.get("modes"),e=b.get("modes");if(d.length>0){if(e.length===0)return-1;f=g=-1;for(c=0;c<j.length;c++)j[c].mode===d[0]&&(f=c);for(c=0;c<j.length;c++)j[c].mode===e[0]&&(g=c);if(f<g)return-1;if(f>g)return 1}else if(e.length>0)return 1;return h=a.get("nick").toLocaleUpperCase(),i=b.get("nick").toLocaleUpperCase(),h<i?-1:h>i?1:(console.log("Something's gone wrong somewhere - two users have the same nick!"),0)},initialize:function(a){this.view=new kiwi.view.MemberList({model:this})},getByNick:function(a){if(typeof a!="string")return;return this.find(function(b){return a.toLowerCase()===b.get("nick").toLowerCase()})}}),kiwi.model.Member=Backbone.Model.extend({sortModes:function(a){return a.sort(function(a,b){var c,d,e,f=kiwi.gateway.get("user_prefixes");for(e=0;e<f.length;e++)f[e].mode===a&&(c=e);for(e=0;e<f.length;e++)f[e].mode===b&&(d=e);return c<d?-1:c>d?1:0})},initialize:function(a){var b,c,d;b=this.stripPrefix(this.get("nick")),c=this.get("modes"),c=c||[],this.sortModes(c),this.set({nick:b,modes:c,prefix:this.getPrefix(c)},{silent:!0})},addMode:function(a){var b=a.split(""),c,d;c=this.get("modes"),$.each(b,function(a,b){c.push(b)}),c=this.sortModes(c),this.set({prefix:this.getPrefix(c),modes:c})},removeMode:function(a){var b=a.split(""),c,d;c=this.get("modes"),c=_.reject(c,function(a){return b.indexOf(a)!==-1}),this.set({prefix:this.getPrefix(c),modes:c})},getPrefix:function(a){var b="",c=kiwi.gateway.get("user_prefixes");return typeof a[0]!="undefined"&&(b=_.detect(c,function(b){return b.mode===a[0]}),b=b?b.symbol:""),b},stripPrefix:function(a){var b=a,c,d,e,f=kiwi.gateway.get("user_prefixes");c=0;for(d=0;d<a.length;d++)for(e=0;e<f.length;e++)if(a.charAt(d)===f[e].symbol){c++;break}return b.substr(c)},displayNick:function(a){var b=this.get("nick");return a&&this.get("ident")&&(b+=" ["+this.get("ident")+"@"+this.get("hostname")+"]"),b}}),kiwi.model.PanelList=Backbone.Collection.extend({model:kiwi.model.Panel,active:null,comparator:function(a){return a.get("name")},initialize:function(){this.view=new kiwi.view.Tabs({el:$("#toolbar .panellist")[0],model:this}),this.server=new kiwi.model.Server({name:kiwi.gateway.get("name")}),kiwi.gateway.on("change:name",this.view.render,this.view),this.add(this.server),this.bind("active",function(a){this.active=a},this)},getByName:function(a){if(typeof a!="string")return;return this.find(function(b){return a.toLowerCase()===b.get("name").toLowerCase()})}}),kiwi.model.Panel=Backbone.Model.extend({initialize:function(a){var b=this.get("name")||"";this.view=new kiwi.view.Panel({model:this,name:b}),this.set({scrollback:[],name:b},{silent:!0})},addMsg:function(a,b,c,d){var e,f,g;d=d||{};if(!d||typeof d.time=="undefined")g=new Date,d.time=g.getHours().toString().lpad(2,"0")+":"+g.getMinutes().toString().lpad(2,"0")+":"+g.getSeconds().toString().lpad(2,"0");if(!d||typeof d.style=="undefined")d.style="";b=$("<div />").text(b).html(),e={msg:b,time:d.time,nick:a,chan:this.get("name"),type:c,style:d.style};if(!e)return;typeof e.type!="string"&&(e.type=""),typeof e.msg!="string"&&(e.msg=""),e.msg=formatIRCMsg(e.msg),f=this.get("scrollback"),f.push(e),f.length>250&&f.splice(250),this.set({scrollback:f},{silent:!0}),this.trigger("msg",e)},close:function(){this.view.remove(),delete this.view;var a=this.get("members");a&&(a.reset([]),this.unset("members")),this.destroy(),this.cid===kiwi.app.panels.active.cid&&kiwi.app.panels.server.view.show()},isChannel:function(){var a=kiwi.gateway.get("channel_prefix"),b=this.get("name");return b?a.indexOf(b[0])>-1:!1}}),kiwi.model.Server=kiwi.model.Panel.extend({server_login:null,initialize:function(a){var b="Server";this.view=new kiwi.view.Panel({model:this,name:b}),this.set({scrollback:[],name:b},{silent:!0}),this.server_login=new kiwi.view.ServerSelect,this.view.$el.append(this.server_login.$el),this.server_login.show()}}),kiwi.model.Channel=kiwi.model.Panel.extend({initialize:function(a){var b=this,c=this.get("name")||"",d;this.view=new kiwi.view.Channel({model:this,name:c}),this.set({members:new kiwi.model.MemberList,name:c,scrollback:[],topic:""},{silent:!0}),d=this.get("members"),d.bind("add",function(a){this.addMsg(" ","--> "+a.displayNick(!0)+" has joined","action join")},this),d.bind("remove",function(a,b,c){var d=c.message?"("+c.message+")":"";c.type==="quit"?this.addMsg(" ","<-- "+a.displayNick(!0)+" has quit "+d,"action quit"):this.addMsg(" ","<-- "+a.displayNick(!0)+" has left "+d,"action part")},this)}}),kiwi.model.Application=Backbone.Model.extend(new function(){var a=this,b={};this.panels=null,this.initialize=function(){a=this},this.start=function(){kiwi.gateway=new kiwi.model.Gateway,this.bindGatewayCommands(kiwi.gateway),this.initializeClient(),this.view.barsHide(!0),this.panels.server.server_login.bind("server_connect",function(a){b=a,kiwi.gateway.set("nick",a.nick),kiwi.gateway.connect(a.server,6667,!1,!1,function(){})})},this.initializeClient=function(){this.view=new kiwi.view.Application({model:this,el:this.get("container")}),this.panels=new kiwi.model.PanelList,this.controlbox=new kiwi.view.ControlBox({el:$("#controlbox")[0]}),this.bindControllboxCommands(this.controlbox),this.topicbar=new kiwi.view.TopicBar({el:$("#topic")[0]}),this.panels.server.view.show(),this.view.doLayout(),this.panels.server.server_login.populateFields({nick:getQueryVariable("nick")||"kiwi_"+Math.ceil(Math.random()*1e4).toString(),server:getQueryVariable("server")||"irc.kiwiirc.com",channel:window.location.hash||"#test"})},this.bindGatewayCommands=function(c){c.on("onmotd",function(b){a.panels.server.addMsg(b.server,b.msg,"motd")}),c.on("onconnect",function(c){a.view.barsShow(),b.channel&&kiwi.gateway.join(b.channel)}),c.on("onjoin",function(b){var c,d,e;c=a.panels.getByName(b.channel),c||(c=new kiwi.model.Channel({name:b.channel}),a.panels.add(c)),d=c.get("members");if(!d)return;e=new kiwi.model.Member({nick:b.nick,ident:b.ident,hostname:b.hostname}),d.add(e)}),c.on("onpart",function(b){var c,d,e,f={};f.type="part",f.message=b.message||"",c=a.panels.getByName(b.channel);if(!c)return;if(b.nick===kiwi.gateway.get("nick")){c.close();return}d=c.get("members");if(!d)return;e=d.getByNick(b.nick);if(!e)return;d.remove(e,f)}),c.on("onquit",function(b){var c,d,e={};e.type="quit",e.message=b.message||"",$.each(a.panels.models,function(a,d){if(!d.isChannel())return;c=d.get("members").getByNick(b.nick),c&&d.get("members").remove(c,e)})}),c.on("onmsg",function(b){var c,d=b.channel==kiwi.gateway.get("nick");d?(c=a.panels.getByName(b.nick),c||(c=new kiwi.model.Channel({name:b.nick}),a.panels.add(c))):(c=a.panels.getByName(b.channel),c||(c=a.panels.server)),c.addMsg(b.nick,b.msg)}),c.on("onnotice",function(b){var c;c=a.panels.getByName(b.target)||a.panels.getByName(b.nick),c||(c=a.panels.server),c.addMsg("["+(b.nick||"")+"]",b.msg)}),c.on("onaction",function(b){var c,d=b.channel==kiwi.gateway.get("nick");d?(c=a.panels.getByName(b.nick),c||(c=new kiwi.model.Channel({name:b.nick}),a.panels.add(c))):(c=a.panels.getByName(b.channel),c||(c=a.panels.server)),c.addMsg("","* "+b.nick+" "+b.msg,"action")}),c.on("ontopic",function(b){var c;c=a.panels.getByName(b.channel);if(!c)return;c.set("topic",b.topic),c.get("name")===kiwi.app.panels.active.get("name")&&a.topicbar.setCurrentTopic(b.topic)}),c.on("ontopicsetby",function(b){var c,d;c=a.panels.getByName(b.channel);if(!c)return;d=(new Date(b.when*1e3)).toLocaleString(),c.addMsg("","Topic set by "+b.nick+" at "+d,"topic")}),c.on("onuserlist",function(b){var c;c=a.panels.getByName(b.channel);if(!c)return;c.temp_userlist=c.temp_userlist||[],_.each(b.users,function(a){var b=new kiwi.model.Member({nick:a.nick,modes:a.modes});c.temp_userlist.push(b)})}),c.on("onuserlist_end",function(b){var c;c=a.panels.getByName(b.channel);if(!c)return;c.get("members").reset(c.temp_userlist||[]),delete c.temp_userlist}),c.on("onmode",function(b){var c,d,e;if(!b.channel)return;c=a.panels.getByName(b.channel);if(!c)return;d=c.get("members");if(!d)return;e=d.getByNick(b.effected_nick);if(!e)return;b.mode[0]==="+"?e.addMode(b.mode.substr(1)):b.mode[0]==="-"&&e.removeMode(b.mode.substr(1))}),c.on("onnick",function(b){var c;$.each(a.panels.models,function(a,d){if(!d.isChannel())return;c=d.get("members").getByNick(b.nick),c&&(c.set("nick",b.newnick),d.addMsg("","== "+b.nick+" is now known as "+b.newnick,"action nick"))})})},this.bindControllboxCommands=function(a){a.on("unknown_command",this.unknownCommand),a.on("command",this.allCommands),a.on("command_msg",this.msgCommand),a.on("command_action",this.actionCommand),a.on("command_me",this.actionCommand),a.on("command_join",this.joinCommand),a.on("command_j",this.joinCommand),a.on("command_part",this.partCommand),a.on("command_p",this.partCommand),a.on("command_nick",function(a){kiwi.gateway.changeNick(a.params[0])}),a.on("command_query",this.queryCommand),a.on("command_q",this.queryCommand),a.on("command_topic",this.topicCommand),a.on("command_notice",this.noticeCommand),a.on("command_css",function(a){var b="?reload="+(new Date).getTime();$('link[rel="stylesheet"]').each(function(){this.href=this.href.replace(/\?.*|$/,b)})})},this.unknownCommand=function(a){var b=a.command+" "+a.params.join(" ");console.log("RAW: "+b),kiwi.gateway.raw(b)},this.allCommands=function(a){console.log("allCommands",a)},this.joinCommand=function(b){var c,d;d=b.params.join(" ").split(","),$.each(d,function(b,d){d=d.trim(),c=a.panels.getByName(d),c||(c=new kiwi.model.Channel({name:d}),kiwi.app.panels.add(c)),kiwi.gateway.join(d)}),c&&c.view.show()},this.queryCommand=function(b){var c,d;c=b.params[0],d=a.panels.getByName(c),d||(d=new kiwi.model.Channel({name:c}),kiwi.app.panels.add(d)),d&&d.view.show()},this.msgCommand=function(b){var c=b.params[0],d=a.panels.getByName(c)||a.panels.server;b.params.shift(),d.addMsg(kiwi.gateway.get("nick"),b.params.join(" ")),kiwi.gateway.privmsg(c,b.params.join(" "))},this.actionCommand=function(a){if(kiwi.app.panels.active===kiwi.app.panels.server)return;var b=kiwi.app.panels.active;b.addMsg("","* "+kiwi.gateway.get("nick")+" "+a.params.join(" "),"action"),kiwi.gateway.action(b.get("name"),a.params.join(" "))},this.partCommand=function(a){a.params.length===0?kiwi.gateway.part(kiwi.app.panels.active.get("name")):_.each(a.params,function(a){kiwi.gateway.part(a)})},this.topicCommand=function(b){var c;if(b.params.length===0)return;a.isChannelName(b.params[0])?(c=b.params[0],b.params.shift()):c=kiwi.app.panels.active.get("name"),kiwi.gateway.topic(c,b.params.join(" "))},this.noticeCommand=function(a){var b;if(a.params.length<=1)return;b=a.params[0],a.params.shift(),kiwi.gateway.notice(b,a.params.join(" "))},this.isChannelName=function(a){var b=kiwi.gateway.get("channel_prefix");return!a||!a.length?!1:b.indexOf(a[0])>-1}}),kiwi.model.Gateway=Backbone.Model.extend(new function(){var a=this;this.defaults={name:"Server",address:"",nick:"",channel_prefix:"#",user_prefixes:["~","&","@","+"],kiwi_server:"http://localhost:7778/kiwi"},this.initialize=function(){a=this,this.socket=this.get("socket"),this.session_id="",network=this},this.connect=function(b,c,d,e,f){this.socket=io.connect(this.get("kiwi_server"),{"try multiple transports":!0,"connect timeout":3e3,"max reconnection attempts":7,"reconnection delay":2e3}),this.socket.on("connect_failed",function(a){console.debug("Unable to connect Socket.IO",a),console.log("kiwi.gateway.socket.on('connect_failed')"),this.socket.disconnect(),this.emit("connect_fail",{reason:a})}),this.socket.on("error",function(a){this.emit("connect_fail",{reason:a}),console.log("kiwi.gateway.socket.on('error')",{reason:a})}),this.socket.on("connecting",function(b){console.log("kiwi.gateway.socket.on('connecting')"),this.emit("connecting"),a.trigger("connecting")}),this.socket.on("connect",function(){this.emit("irc connect",a.get("nick"),b,c,d,e,f),console.log("kiwi.gateway.socket.on('connect')")}),this.socket.on("too_many_connections",function(){this.emit("connect_fail",{reason:"too_many_connections"})}),this.socket.on("message",this.parse),this.socket.on("disconnect",function(){this.emit("disconnect",{}),console.log("kiwi.gateway.socket.on('disconnect')")}),this.socket.on("close",function(){console.log("kiwi.gateway.socket.on('close')")}),this.socket.on("reconnecting",function(a,b){console.log("kiwi.gateway.socket.on('reconnecting')"),this.emit("reconnecting",{delay:a,attempts:b})}),this.socket.on("reconnect_failed",function(){console.log("kiwi.gateway.socket.on('reconnect_failed')")})},this.parse=function(b){console.log("gateway event",b);if(b.event!==undefined){a.trigger("on"+b.event,b);switch(b.event){case"options":$.each(b.options,function(b,c){switch(b){case"CHANTYPES":a.set("channel_prefix",c.charAt(0));break;case"NETWORK":a.set("name",c);break;case"PREFIX":a.set("user_prefixes",c)}});break;case"connect":a.set("nick",b.nick);break;case"nick":b.nick===a.get("nick")&&a.set("nick",b.newnick);break;case"kiwi":this.emit("kiwi."+b.namespace,b.data)}}},this.sendData=function(a,b){this.socket.emit("message",{sid:this.session_id,data:JSON.stringify(a)},b)},this.privmsg=function(a,b,c){var d={method:"privmsg",args:{target:a,msg:b}};this.sendData(d,c)},this.notice=function(a,b,c){var d={method:"notice",args:{target:a,msg:b}};this.sendData(d,c)},this.ctcp=function(a,b,c,d,e){var f={method:"ctcp",args:{request:a,type:b,target:c,params:d}};this.sendData(f,e)},this.action=function(a,b,c){this.ctcp(!0,"ACTION",a,b,c)},this.join=function(a,b,c){var d={method:"join",args:{channel:a,key:b}};this.sendData(d,c)},this.part=function(a,b){var c={method:"part",args:{channel:a}};this.sendData(c,b)},this.topic=function(a,b,c){var d={method:"topic",args:{channel:a,topic:b}};this.sendData(d,c)},this.kick=function(a,b,c,d){var e={method:"kick",args:{channel:a,nick:b,reason:c}};this.sendData(e,d)},this.quit=function(a,b){a=a||"";var c={method:"quit",args:{message:a}};this.sendData(c,b)},this.raw=function(a,b){a={method:"raw",args:{data:a}},this.sendData(a,b)},this.changeNick=function(a,b){var c={method:"nick",args:{nick:a}};this.sendData(c,b)},this.kiwi=function(a,b,c){b={method:"kiwi",args:{target:a,data:b}},this.sendData(b,c)}}),kiwi.view={},kiwi.view.MemberList=Backbone.View.extend({tagName:"ul",events:{"click .nick":"nickClick"},initialize:function(a){this.model.bind("all",this.render,this),$(this.el).appendTo("#memberlists")},render:function(){var a=$(this.el);a.empty(),this.model.forEach(function(b){$('<li><a class="nick"><span class="prefix">'+b.get("prefix")+"</span>"+b.get("nick")+"</a></li>").appendTo(a).data("member",b)})},nickClick:function(a){var b=$(a.currentTarget).parent("li"),c=b.data("member"),d=new kiwi.view.UserBox;d.member=c,$(".userbox",this.$el).remove(),b.append(d.$el)},show:function(){$("#memberlists").children().removeClass("active"),$(this.el).addClass("active")}}),kiwi.view.UserBox=Backbone.View.extend({member:{},events:{"click .query":"queryClick","click .info":"infoClick"},initialize:function(){this.$el=$($("#tmpl_userbox").html())},queryClick:function(a){var b=new kiwi.model.Channel({name:this.member.get("nick")});kiwi.app.panels.add(b),b.view.show()},infoClick:function(a){kiwi.gateway.raw("WHOIS "+this.member.get("nick"))}}),kiwi.view.ServerSelect=Backbone.View.extend({events:{"submit form":"submitLogin","click .show_more":"showMore"},initialize:function(){this.$el=$($("#tmpl_server_select").html()),kiwi.gateway.bind("onconnect",this.networkConnected,this),kiwi.gateway.bind("connecting",this.networkConnecting,this)},submitLogin:function(a){var b={nick:$(".nick",this.$el).val(),server:$(".server",this.$el).val(),channel:$(".channel",this.$el).val()};return this.trigger("server_connect",b),!1},showMore:function(a){$(".more",this.$el).slideDown("fast")},populateFields:function(a){var b,c,d;a=a||{},b=a.nick||"",c=a.server||"",d=a.channel||"",$(".nick",this.$el).val(b),$(".server",this.$el).val(c),$(".channel",this.$el).val(d)},hide:function(){this.$el.slideUp()},show:function(){this.$el.show(),$(".nick",this.$el).focus()},setStatus:function(a,b){$(".status",this.$el).text(a).attr("class","status").addClass(b).show()},clearStatus:function(){$(".status",this.$el).hide()},networkConnected:function(a){this.setStatus("Connected :)","ok"),$("form",this.$el).hide()},networkConnecting:function(a){this.setStatus("Connecting..","ok")}}),kiwi.view.Panel=Backbone.View.extend({tagName:"div",className:"messages",events:{"click .chan":"chanClick"},$container:null,initialize:function(a){this.initializePanel(a)},initializePanel:function(a){this.$el.css("display","none"),a.container?this.$container=$(a.container):this.$container=$("#panels .container1"),this.$el.appendTo(this.$container),this.model.bind("msg",this.newMsg,this),this.msg_count=0,this.model.set({view:this},{silent:!0})},render:function(){this.$el.empty(),this.model.get("backscroll").forEach(this.newMsg)},newMsg:function(a){var b,c,d=this.$el;b=new RegExp("\\B("+kiwi.gateway.channel_prefix+"[^ ,.\\007]+)","g"),a.msg=a.msg.replace(b,function(a){return'<a class="chan">'+a+"</a>"}),c='<div class="msg <%= type %>"><div class="time"><%- time %></div><div class="nick"><%- nick %></div><div class="text" style="<%= style %>"><%= msg %> </div></div>',d.append(_.template(c,a)),this.scrollToBottom(),this.msg_count++,this.msg_count>250&&($(".msg:first",this.div).remove(),this.msg_count--)},chanClick:function(a){console.log(a)},show:function(){var a=this.$el;this.$container.children().css("display","none"),a.css("display","block");var b=this.model.get("members");b?(b.view.show(),this.$container.parent().css("right","200px")):($("#memberlists").children().removeClass("active"),this.$container.parent().css("right","0")),this.scrollToBottom(),this.trigger("active",this.model),kiwi.app.panels.trigger("active",this.model)},scrollToBottom:function(){this.$container[0].scrollTop=this.$container[0].scrollHeight}}),kiwi.view.Channel=kiwi.view.Panel.extend({initialize:function(a){this.initializePanel(a),this.model.bind("change:topic",this.topic,this)},topic:function(a){if(typeof a!="string"||!a)a=this.model.get("topic");this.model.addMsg("","=== Topic for "+this.model.get("name")+" is: "+a,"topic"),kiwi.app.panels.active===this&&kiwi.app.topicbar.setCurrentTopic(this.model.get("topic"))}}),kiwi.view.Tabs=Backbone.View.extend({events:{"click li":"tabClick","click li img":"partClick"},initialize:function(){this.model.on("add",this.panelAdded,this),this.model.on("remove",this.panelRemoved,this),this.model.on("reset",this.render,this)},render:function(){var a=this;$this=$(this.el),$this.empty(),$("<li><span>"+kiwi.gateway.get("name")+"</span></li>").data("panel_id",this.model.server.cid).appendTo($this),this.model.forEach(function(b){if(b==a.model.server)return;$("<li><span>"+b.get("name")+"</span></li>").data("panel_id",b.cid).appendTo($this)})},panelAdded:function(a){a.tab=$("<li><span>"+a.get("name")+"</span></li>"),a.tab.data("panel_id",a.cid).appendTo(this.$el),a.view.on("active",this.panelActive,this)},panelRemoved:function(a){a.tab.remove(),delete a.tab},panelActive:function(a){$("img",this.$el).remove(),this.$el.children().removeClass("active"),a.tab.addClass("active"),a.tab.append('<img src="img/redcross.png" />')},tabClick:function(a){var b=this.model.getByCid($(a.currentTarget).data("panel_id"));if(!b)return;b.view.show()},partClick:function(a){var b=this.model.getByCid($(a.currentTarget).parent().data("panel_id"));b.isChannel()?kiwi.gateway.part(b.get("name")):b.close()}}),kiwi.view.TopicBar=Backbone.View.extend({events:{"keydown input":"process"},initialize:function(){kiwi.app.panels.bind("active",function(a){this.setCurrentTopic(a.get("topic"))},this)},process:function(a){var b=$(a.currentTarget),c=b.val();if(a.keyCode!==13)return;kiwi.app.panels.active.isChannel()&&kiwi.gateway.topic(kiwi.app.panels.active.get("name"),c)},setCurrentTopic:function(a){$("input",this.$el).val(a)}}),kiwi.view.ControlBox=Backbone.View.extend({buffer:[],buffer_pos:0,events:{"keydown input":"process"},initialize:function(){var a=this;that=this,kiwi.gateway.bind("change:nick",function(){$(".nick",a.$el).text(this.get("nick"))})},process:function(a){var b=$(a.currentTarget),c=b.val();switch(!0){case a.keyCode===13:c=c.trim(),c&&(this.processInput(b.val()),this.buffer.push(b.val()),this.buffer_pos=this.buffer.length),b.val("");break;case a.keyCode===38:this.buffer_pos>0&&(this.buffer_pos--,b.val(this.buffer[this.buffer_pos]));break;case a.keyCode===40:this.buffer_pos<this.buffer.length&&(this.buffer_pos++,b.val(this.buffer[this.buffer_pos]))}},processInput:function(a){var b,c=a.split(" ");c[0][0]==="/"?(b=c[0].substr(1).toLowerCase(),c=c.splice(1)):(b="msg",c.unshift(kiwi.app.panels.active.get("name"))),this.trigger("command",{command:b,params:c}),this.trigger("command_"+b,{command:b,params:c}),this._callbacks["command_"+b]||this.trigger("unknown_command",{command:b,params:c})}}),kiwi.view.Application=Backbone.View.extend({initialize:function(){$(window).resize(this.doLayout),$("#toolbar").resize(this.doLayout),$("#controlbox").resize(this.doLayout),this.doLayout(),$(window).keydown(this.setKeyFocus)},setKeyFocus:function(a){if(a.ctrlKey||a.altKey)return;if(a.srcElement.tagName.toLowerCase()==="input")return;$("#controlbox .inp").focus()},doLayout:function(){var a=$("#panels"),b=$("#memberlists"),c=$("#toolbar"),d=$("#controlbox"),e={top:c.outerHeight(!0),bottom:d.outerHeight(!0)};a.css(e),b.css(e)},barsHide:function(a){var b=this;a?($("#toolbar").slideUp(0),$("#controlbox").slideUp(0)):($("#toolbar").slideUp(),$("#controlbox").slideUp(function(){b.doLayout()}))},barsShow:function(a){var b=this;a?($("#toolbar").slideDown(0),$("#controlbox").slideDown(0),this.doLayout()):($("#toolbar").slideDown(),$("#controlbox").slideDown(function(){b.doLayout()}))}})