<style>

	#kiwi .persist-form {
		display: block;
		margin: 1em auto;
		width: 300px;
	}

	#kiwi .persist-form label {
		display: block;
		font-size: 1.2em;
		margin: 1em 0 5px 0;
	}

	#kiwi .persist-form button {
		margin-top: 5px;
	}

	#kiwi .persist-form input {}

	#kiwi .persist-actions {
		width: 300px;
		margin: 10px auto 0 auto;
	}

	#kiwi .persist-channel { cursor: pointer; }

	#kiwi .persist-connections {
		width: 300px;
		margin: 0 auto;
	}

	#kiwi .persist-connection {
		margin-top: 1em;
	}
	#kiwi .persist-connection li {
		margin-left: 1em;
		margin-bottom: 5px;
		list-style: none;
	}
	#kiwi .persist-connection li i {
		display: none;
		float: right;
	}
	#kiwi .persist-connection li.subscribed i {
		display: inline;
	}
</style>


<script type="text/html" id="tmpl_myplugin">
        <div class="persist">
        	<div class="status"></div>
            <form class="persist-form">
                    <label>Username</label>
                    <input type="text" name="username" />

                    <br />

                    <label>Password</label>
                    <input type="password" name="password" />

                    <br />

                    <button type="submit">Login</button>
            </form>

            <div class="persist-actions">
	            <button class="activate_bnc">Activate Bouncer Mode</button> <br /> <br />
    	        <button class="skip">Connect to new network</button>
    	    </div>

    	    <div class="persist-connections"></div>
        </div>
</script>

<script>

	(function() {
		var connectionView = Backbone.View.extend({
			className: 'persist-connection',

			events: {
				'click .persist-channel': 'channelClick'
			},

			render: function() {
				$('<b></b>')
					.text(this.model.get('address') + ' (' + this.model.get('nick') + ')')
					.appendTo(this.$el);

				var $chan_list = $('<ul>');
				var channels = this.model.get('channels');

				channels.forEach(function(channel) {
					var $el = $('<li class="persist-channel"><span></span><i class="fa fa-check"></i></li>')
						.data('channel', channel);

					$el.find('span').text(channel.get('name'));
					$el.appendTo($chan_list);
				});

				$chan_list.appendTo(this.$el);

				return this;
			},


			channelClick: function(event) {
				var $this = $(event.currentTarget);
				var channel = $this.data('channel');

				if (!channel.get('subscribed')) {
					kiwi.session.syncEvents(this.model.get('connection_id'), channel.get('name'));
					$this.addClass('subscribed');
					channel.set('subscribed', true);
				} else {
					kiwi.session.unsubscribeTarget(this.model.get('connection_id'), channel.get('name'));
					$this.removeClass('subscribed');
					channel.set('subscribed', false);
				}
			}
		});




		var myPluginView = Backbone.View.extend({
			events: {
				'submit form': 'formSubmit',
				'click .skip': 'skipClick',
				'click .activate_bnc': 'activateBnc'
			},

			initialize: function() {
				var that = this;

				this.listenTo(kiwi.session, 'save', function(err, data) {
					if (err) {
						that.$('.status').text('Error: ' + err);
					} else {
						that.$('.status').text(data);
						this.renderButtons();
					}
				});

				this.listenTo(kiwi.session, 'sync_error', function(err) {
					that.$('.status').text('Error: ' + err);
				});

				// Event is called when the network object and channels have been created. Only thing left
				// is to sync the channel events
				this.listenTo(kiwi.session, 'change:synced', function() {
					var connections = kiwi.session.available_connections;
					connections.forEach(function(connection) {
						var connection_view = new connectionView({model: connection});
						this.$('.persist-connections').append(connection_view.render().$el);
					});

					this.renderButtons();
				});

				var network = kiwi.components.Network();
				this.listenTo(network, 'connect', this.renderButtons);
			},

			render: function() {
				this.$el.html($('#tmpl_myplugin').html());
				this.renderButtons();
			},

			renderButtons: function() {
				if (kiwi.connections.length === 0) {
					this.$('.activate_bnc').hide();
				} else {
					this.$('.activate_bnc').show();
				}

				if (kiwi.session.get('synced')) {
					this.$('form').hide();
					this.$('.activate_bnc').hide();
				} else {
					this.$('form').show();
				}
			},

			formSubmit: function(event) {
				var that = this;

				event.preventDefault();

				var username = this.$('[name=username]').val();
				var password = this.$('[name=password]').val();

				kiwi.session.resume(username, password);
			},

			skipClick: function(event) {
				var applet = kiwi.components.Applet.loadOnce('kiwi_startup');
				applet.view.show();
			},

			activateBnc: function() {
				var that = this;
				var username = this.$('[name=username]').val();
				var password = this.$('[name=password]').val();

				if (!username || !password) {
					that.$('.status').text('A username/password must be given');
					return;
				}

				kiwi.session.save(username, password);
			}
		});


		var myPluginApplet = Backbone.Model.extend({
			initialize: function() {
				console.log('plugin showing');
				this.view = new myPluginView({model: this});
				this.view.render();
			}
		});

		kiwi.components.Applet.register('my_plugin', myPluginApplet);
		kiwi.registerStartupApplet('my_plugin');

	})();


</script>