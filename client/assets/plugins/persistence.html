<script type="text/html" id="tmpl_myplugin">
        <div class="my_plugin">
        	<div class="status"></div>
            <form>
                    <label>Username <input type="text" name="username" /> </label> <br />
                    <label>Password <input type="password" name="password" /> </label>  <br />
                    <button type="submit">Login</button>
            </form>

            <button class="activate_bnc">Activate Bouncer Mode</button> <br /> <br />
            <button class="skip">Connect to new network</button>
        </div>
</script>

<script>

	var myPluginView = Backbone.View.extend({
		events: {
			'submit form': 'formSubmit',
			'click .skip': 'skipClick',
			'click .activate_bnc': 'activateBnc'
		},

		initialize: function() {
			var that = this;

			this.has_synced = false;

			this.listenTo(kiwi.session, 'save', function(err, data) {
				if (err) {
					that.$('.status').text('Error: ' + err);
				} else {
					that.$('.status').text(data);
					this.has_synced = true;
					this.renderButtons();
				}
			});

			this.listenTo(kiwi.session, 'sync_error', function(err) {
				that.$('.status').text('Error: ' + err);
			});

			// Event is called when the network object and channels have been created. Only thing left
			// is to sync the channel events
			this.listenTo(kiwi.session, 'synced', function(connections) {
				_.each(connections, function(connection) {
					kiwi.session.syncEvents(connection.connection_id);
				});

				this.has_synced = true;
				this.renderButtons();
			});

			var network = kiwi.components.Network();
			this.listenTo(network, 'connected', this.renderButtons);
		},

		render: function() {
			this.$el.html($('#tmpl_myplugin').html());
			this.renderButtons();
		},

		renderButtons: function() {
			if (kiwi.connections.length === 0) {
				this.$('.activate_bnc').hide();
			} else {
				this.$('.activate_bnc').show();
			}

			if (this.has_synced) {
				this.$('form').hide();
				this.$('.activate_bnc').hide();
			} else {
				this.$('form').show();
			}
		},

		formSubmit: function(event) {
			var that = this;

			event.preventDefault();

			var username = this.$('[name=username]').val();
			var password = this.$('[name=password]').val();

			kiwi.session.resume(username, password);
		},

		skipClick: function(event) {
			var applet = kiwi.components.Applet.loadOnce('kiwi_startup');
			applet.view.show();
		},

		activateBnc: function() {
			var that = this;
			var username = this.$('[name=username]').val();
			var password = this.$('[name=password]').val();

			if (!username || !password) {
				that.$('.status').text('A username/password must be given');
				return;
			}

			kiwi.session.save(username, password);
		}
	});


	var myPluginApplet = Backbone.Model.extend({
		initialize: function() {
			console.log('plugin showing');
			this.view = new myPluginView({model: this});
			this.view.render();
		}
	});

	kiwi.components.Applet.register('my_plugin', myPluginApplet);
	kiwi.registerStartupApplet('my_plugin');


</script>